<!DOCTYPE html>
<html>
<head>
    <title>SIEM MONITOR - LIVE</title>
    <style>
        body { background-color: #1a1a1a; color: #e0e0e0; font-family: monospace; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #00ff00; padding-bottom: 10px; }
        .btn { background: #00ff00; color: black; padding: 10px 20px; text-decoration: none; font-weight: bold; border-radius: 4px; cursor: pointer; border:none;}
        .btn-danger { background: #ff3333; color: white; }
        
        /* Zone de Config */
        .config-panel { background: #2d2d2d; padding: 15px; margin-top: 20px; border-radius: 5px; display: flex; align-items: center; gap: 15px; border-left: 5px solid #00ff00; }
        input[type="text"] { padding: 8px; border-radius: 4px; border: none; width: 300px; }
        
        .cards { display: flex; gap: 20px; margin-top: 20px; }
        .card { background: #2d2d2d; padding: 20px; flex: 1; text-align: center; border-radius: 5px; }
        .card h2 { margin: 0; font-size: 3em; }
        
        .logs-panel { margin-top: 20px; background: #000; padding: 15px; border: 1px solid #333; height: 400px; overflow-y: scroll; }
        .log-item { padding: 10px; border-bottom: 1px solid #333; cursor: pointer; transition: background 0.2s; }
        .log-item:hover { background-color: #111; }
        .log-details { display: none; margin-top: 10px; padding: 10px; background: #222; border-left: 3px solid #00ff00; color: #ccc; }
        
        .sev-high { color: #ff3333; border-left: 4px solid #ff3333; }
        .sev-med { color: #ffcc00; border-left: 4px solid #ffcc00; }
        .sev-low { color: #00ccff; border-left: 4px solid #00ccff; }
    </style>
</head>
<body>

    <div class="header">
        <h1>üõ°Ô∏è MINI-SIEM DASHBOARD</h1>
        <a href="/download/pdf" class="btn">T√âL√âCHARGER RAPPORT PDF</a>
    </div>

    <div class="config-panel">
        <h3>‚öôÔ∏è CONFIGURATION :</h3>
        
        <input type="text" id="dirInput" placeholder="Chemin du dossier (ex: ./test_data)">
        <button onclick="changeDir()" class="btn">Changer Cible</button>
        
        <div style="flex-grow: 1;"></div>
        
        <span id="statusText" style="font-weight: bold; margin-right: 10px;">ACTIF</span>
        <button id="toggleBtn" onclick="toggleScan()" class="btn">PAUSE</button>
    </div>

    <div class="cards">
        <div class="card">
            <h3>TOTAL</h3>
            <h2 id="total">0</h2>
        </div>
        <div class="card">
            <h3 style="color:red">CRITIQUE</h3>
            <h2 id="critical">0</h2>
        </div>
        <div class="card">
            <h3 style="color:orange">HAUTE</h3>
            <h2 id="high">0</h2>
        </div>
    </div>

    <h3>üî¥ LOGS EN TEMPS R√âEL</h3>
    <div class="logs-panel" id="logs"></div>

<script>
        // Variable pour stocker l'√©tat pr√©c√©dent des logs
        let lastLogsHash = "";

        // Gestion des details (accordeon)
        function toggleDetails(id) {
            var el = document.getElementById('detail-' + id);
            el.style.display = (el.style.display === "block") ? "none" : "block";
        }

        // Changement de repertoire
        function changeDir() {
            const path = document.getElementById('dirInput').value;
            fetch('/api/config/dir', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({path: path})
            })
            .then(r => r.json())
            .then(d => {
                if (d.status === "error") {
                    alert("‚õî " + (d.message || "Erreur inconnue"));
                } else {
                    alert("‚úÖ Cible modifi√©e : " + d.path);
                }
            });
        }

        // Pause / Reprise
        function toggleScan() {
            fetch('/api/config/toggle', {method: 'POST'})
                .then(r => r.json())
                .then(data => updateStatusUI(data.active));
        }

        function updateStatusUI(isActive) {
            const btn = document.getElementById('toggleBtn');
            const txt = document.getElementById('statusText');
            if (isActive) {
                btn.innerText = "METTRE EN PAUSE";
                btn.className = "btn btn-danger";
                txt.innerText = "üü¢ SCAN EN COURS";
                txt.style.color = "#00ff00";
            } else {
                btn.innerText = "REPRENDRE";
                btn.className = "btn";
                txt.innerText = "üî¥ SCAN ARR√äT√â";
                txt.style.color = "red";
            }
        }

        function updateDashboard() {
            // 1. Logs et Stats
            fetch('/api/data').then(r => r.json()).then(data => {
                // Mise √† jour des compteurs (toujours faire √ßa)
                document.getElementById('total').innerText = data.stats.count;
                document.getElementById('critical').innerText = data.stats.critical;
                document.getElementById('high').innerText = data.stats.high;

                // --- CORRECTION ICI ---
                // On transforme les logs en cha√Æne de caract√®res pour comparer
                const currentLogsHash = JSON.stringify(data.logs);

                // Si les donn√©es n'ont pas chang√© depuis la derni√®re fois, on NE TOUCHE PAS au HTML
                // Cela √©vite de refermer les accord√©ons que vous √™tes en train de lire
                if (currentLogsHash === lastLogsHash) {
                    return; 
                }

                // Si c'est diff√©rent, on met √† jour la m√©moire et le HTML
                lastLogsHash = currentLogsHash;

                const logsDiv = document.getElementById('logs');
                let html = "";
                data.logs.reverse().forEach((log, index) => {
                    let color = log.sev >= 90 ? 'sev-high' : (log.sev >= 50 ? 'sev-med' : 'sev-low');
                    html += `
                    <div class="log-item ${color}" onclick="toggleDetails(${index})">
                        <div style="display:flex; justify-content:space-between;">
                            <span>${log.title}</span>
                            <strong>${log.sev}</strong>
                        </div>
                        <div id="detail-${index}" class="log-details">
                            <p>‚ùå ${log.detail}</p>
                            <p>‚úÖ ${log.sol}</p>
                        </div>
                    </div>`;
                });
                logsDiv.innerHTML = html;
            });

            // 2. Config status
            fetch('/api/status').then(r => r.json()).then(data => {
                if (document.activeElement.id !== "dirInput") {
                    document.getElementById('dirInput').value = data.directory;
                }
                updateStatusUI(data.active);
            });
        }
        
        setInterval(updateDashboard, 2000);
        updateDashboard();
    </script>
</body>
</html>